<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Chat Room</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    	<script src="/socket.io/socket.io.js"></script>
	</head>
	<style>
		#chatForm{
			padding:5px;
			position:fixed;
			bottom: 0;
			margin-right: 2%;
			margin-left: 2%;
			width:96%;
		}
		#messages li { padding: 5px 10px; }
		#messages li:nth-child(odd) { background: #eee; }
		#logout{
			float: right;
		}
	</style>
	<body>
		<div class="container-fluid">
			<button type="submit" id="logout" onclick="logout()" class="btn btn-outline-danger">Logout</button>
			<div id="parent" class="row"></div>
			<br>
			<div id="row" class="row border" data-spy="scroll">
				<div id="leftcol" class="col-4">
					<h4>Online Users:</h4>
					<ul id="sockets"></ul>
				</div>
				<div id="rightcol" class="col-8 border">
					<h4>Messages:</h4>
					<ul id="messages"></ul>
				</div>
			</div>
			<div class="row">
				<form id="chatForm" class="input-group-append border border-dark" onsubmit="return false">
					<input id="textMessage" class="form-control" placeholder="Type your message here..."/>
					<button id="sendButton" onclick="sendMessage()" class="btn btn-outline-success">Send</button>
				</form>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		var socket = io();

		//extract username from stored cookie
		var username = getCookie().username;

		$('#parent').append($('<h2>').html(username+", your Chat Room"));

		socket.emit('username', username);

		//addition of list of available 'online' sockets
		socket.on('online socket', function(onlineSockets){
			$('#sockets').empty();
			for(var key in onlineSockets){
				$('#sockets').append($('<li>').html(onlineSockets[key]));
			}
		});

		socket.on('message', function(msg){
		  $('#messages').append($('<li>').html(msg));
		});

		//to extract the 'chat_room_cookie' and stored values
		function getCookie() {
			var name = "chat_room_cookie=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' ') {
					c = c.substring(1);
				}
				if (c.indexOf(name) == 0) {
					return JSON.parse(c.substring(name.length+2, c.length));
				}
			}
			return "nothing";
		}

		//emits 'message'
		function sendMessage() {
			var message = document.getElementById('textMessage').value;
			document.getElementById('textMessage').value="";
			socket.emit("message", message);
		}

		//sends 'get' logout request
		function logout() {
			var settings = {
				"async": true,
				"crossDomain": true,
				"url": "http://localhost:3000/login/logout",
				"method": "GET",
				"credentials": "include",
				"headers": {
					"content-type": "application/x-www-form-urlencoded",
					"cache-control": "no-cache",
				},
			};
			$.ajax(settings).done(function (response) {
				document.location.replace("http://localhost:3000/");
			});
		}
	</script>
</html>
